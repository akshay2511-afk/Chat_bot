<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAN Card Chatbot</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
  font-family: Arial, sans-serif;
  background-image: url("images/def.png");
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  min-height: 100vh;
}

        /* Floating chat trigger button */
        .chat-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: #ffffff;
            color: #0d6efd;
            border: 0;
            padding: 12px 16px;
            border-radius: 999px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.2);
            cursor: pointer;
            font-weight: 700;
            z-index: 1000;
        }

        /* Chat widget container as a small popup */
        .chat-widget {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 360px;
            height: 520px;
            display: none; /* hidden until opened */
            flex-direction: column;
            background: #ffffff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0,0,0,0.25);
            z-index: 1001;
        }

        .header { background: #5b6be6; color: #fff; padding: 12px 16px; font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
        .header .close-btn { background: transparent; color: #fff; border: 0; font-size: 18px; cursor: pointer; }

        .messages { flex: 1; overflow-y: auto; padding: 16px; background: #fafbff; }
        .row { display: flex; margin-bottom: 10px; }
        .row.user { justify-content: flex-end; }
        .bubble { max-width: 70%; padding: 10px 12px; border-radius: 12px; border: 1px solid #e3e7ff; background: #fff; }
        .row.user .bubble { background: #5b6be6; color: #fff; border-color: transparent; }
        .footer { display: flex; gap: 8px; padding: 12px; border-top: 1px solid #e9ecf8; background: #fff; }
        .input { flex: 1; padding: 10px 12px; border: 1px solid #dfe3f6; border-radius: 8px; }
        .btn { background: #5b6be6; color: #fff; border: 0; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn:disabled { opacity: .6; cursor: not-allowed; }
        .error { color: #e74c3c; text-align: center; font-size: 13px; padding: 6px 0; height: 20px; }
        
        /* Consent Banner Styles */
        .consent-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 16px 20px;
            z-index: 1002;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
        }
        
        .consent-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .consent-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .consent-actions {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .consent-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        
        .consent-btn.accept {
            background: #27ae60;
            color: white;
        }
        
        .consent-btn.accept:hover {
            background: #229954;
        }
        
        .consent-btn.decline {
            background: #e74c3c;
            color: white;
        }
        
        .consent-btn.decline:hover {
            background: #c0392b;
        }
        
        .consent-btn.details {
            background: #3498db;
            color: white;
        }
        
        .consent-btn.details:hover {
            background: #2980b9;
        }
        
        .consent-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1003;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .consent-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
            color: #333;
        }
        
        .consent-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .consent-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .consent-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .consent-modal-body {
            line-height: 1.6;
            margin-bottom: 24px;
        }
        
        .consent-modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .consent-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .consent-status.granted {
            background: #d4edda;
            color: #155724;
        }
        
        .consent-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .consent-status.revoked {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
<!-- Consent Banner -->
<div id="consentBanner" class="consent-banner">
    <div class="consent-content">
        <div class="consent-text">
            <strong>üîí Privacy Notice:</strong> We need your consent to process your phone number for providing PAN/TAN assistance services. 
            <a href="#" id="consentDetailsLink" style="color: #3498db; text-decoration: underline;">View details</a>
        </div>
        <div class="consent-actions">
            <button id="consentAccept" class="consent-btn accept">Accept</button>
            <button id="consentDecline" class="consent-btn decline">Decline</button>
                </div>
            </div>
        </div>
        
<!-- Consent Modal -->
<div id="consentModal" class="consent-modal">
    <div class="consent-modal-content">
        <div class="consent-modal-header">
            <h2 class="consent-modal-title">Data Processing Consent</h2>
            <button id="consentModalClose" class="consent-modal-close">&times;</button>
        </div>
        <div class="consent-modal-body" id="consentModalBody">
            <!-- Content will be loaded dynamically -->
        </div>
        <div class="consent-modal-footer">
            <button id="consentModalAccept" class="consent-btn accept">Accept & Continue</button>
            <button id="consentModalDecline" class="consent-btn decline">Decline</button>
        </div>
    </div>
</div>

<button id="chatToggle" class="chat-toggle">üí¨ Chat</button>

<div id="chatWidget" class="chat-widget">
    <div class="header">
        <span>üèõÔ∏è PAN Card Assistant</span>
        <button id="chatClose" class="close-btn" title="Close">‚úï</button>
    </div>

    <div id="error" class="error"></div>

    <div id="messages" class="messages"></div>

    <div class="footer">
        <input id="textInput" class="input" placeholder="Type a message..." disabled>
        <button id="sendBtn" class="btn" disabled>Send</button>
    </div>
    </div>

    <script>
(function(){
  const widget = document.getElementById('chatWidget');
  const toggle = document.getElementById('chatToggle');
  const closeBtn = document.getElementById('chatClose');
  const messagesEl = document.getElementById('messages');
  const textInput = document.getElementById('textInput');
  const sendBtn = document.getElementById('sendBtn');
  // Phone UI removed
  const errorEl = document.getElementById('error');

  const API_CHAT = '/chat';
  const API_CONSENT = '/api/consent';
  // Backend drives the OTP flow now; UI just relays messages

  let senderId = localStorage.getItem('sender_id') || `user_${Math.random().toString(36).slice(2, 10)}`;
  localStorage.setItem('sender_id', senderId);

  let phoneNumber = '';
  let sessionId = null; // obtain from server; new session per phone submission
  let consentGranted = false;
  let currentConsentPolicy = null;
  // Lazy-initialize messages when widget opens for the first time
  let initialized = false;

  function openWidget(){
    widget.style.display = 'flex';
    toggle.style.display = 'none';
    if(!initialized){
      // Ask backend for the greeting + number prompt
      initialized = true;
      enableChat(false);
      fetch(API_CHAT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: '', sender_id: senderId })
      }).then(async res => {
        const data = await res.json().catch(()=>({}));
        if (data && data.session_id) { sessionId = data.session_id; }
        if (data && Array.isArray(data.replies)) {
          data.replies.forEach(r=>{ if(r && r.text){ addBot(r.text); } });
        } else {
          addBot("Hello I'm here to assist you for PAN and TAN and i'm comfortable in both the languages Hindi and English.");
          addBot('Can you provide your number for the smooth conversation?');
        }
      }).catch(()=>{
        addBot("Hello I'm here to assist you for PAN and TAN and i'm comfortable in both the languages Hindi and English.");
        addBot('Can you provide your number for the smooth conversation?');
      }).finally(()=>{
        enableChat(true);
      });
    }
  }

  function closeWidget(){
    widget.style.display = 'none';
    toggle.style.display = 'inline-flex';
    // Release session token when chat is closed
    if (sessionId) {
      try { navigator.sendBeacon('/chat/release', new Blob([JSON.stringify({ session_id: sessionId })], { type: 'application/json' })); } catch(_) {}
      sessionId = null;
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  textInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ sendMessage(); }});
  toggle.addEventListener('click', openWidget);
  closeBtn.addEventListener('click', closeWidget);

  // Consent event listeners
  document.getElementById('consentAccept').addEventListener('click', handleConsentAccept);
  document.getElementById('consentDecline').addEventListener('click', handleConsentDecline);
  document.getElementById('consentDetailsLink').addEventListener('click', (e) => {
    e.preventDefault();
    if (currentConsentPolicy) {
      showConsentModal(currentConsentPolicy);
    }
  });
  document.getElementById('consentModalClose').addEventListener('click', hideConsentModal);
  document.getElementById('consentModalAccept').addEventListener('click', handleConsentAccept);
  document.getElementById('consentModalDecline').addEventListener('click', handleConsentDecline);

  // Release token on page unload/refresh
  window.addEventListener('beforeunload', function(){
    if (sessionId) {
      try { navigator.sendBeacon('/chat/release', new Blob([JSON.stringify({ session_id: sessionId })], { type: 'application/json' })); } catch(_) {}
      sessionId = null;
    }
  });

  function enableChat(enabled){
    textInput.disabled = !enabled; sendBtn.disabled = !enabled;
  }
  function showError(msg){ errorEl.textContent = msg || ''; }

  function addMessage(text, who){
    const row = document.createElement('div'); row.className = `row ${who}`;
    const bubble = document.createElement('div'); bubble.className = 'bubble';
    bubble.textContent = text; row.appendChild(bubble); messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
  function addUser(text){ addMessage(text, 'user'); }
  function addBot(text){ addMessage(text, 'bot'); }

  // Consent Management Functions
  async function checkConsentStatus(phone) {
    if (!phone) return false;
    try {
      const response = await fetch(`${API_CONSENT}/check`, {
                        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone_number: phone, purpose: 'PAN_TAN_ASSISTANCE' })
      });
      const data = await response.json();
      return data.has_consent;
    } catch (error) {
      console.error('Consent check failed:', error);
      return false;
    }
  }

  async function loadConsentBannerData(phone) {
    if (!phone) return null;
    try {
      const response = await fetch(`${API_CONSENT}/banner-data`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone_number: phone, purpose: 'PAN_TAN_ASSISTANCE' })
      });
      return await response.json();
    } catch (error) {
      console.error('Failed to load consent banner data:', error);
      return null;
    }
  }

  async function grantConsent(phone, consentText) {
    try {
      const response = await fetch(`${API_CONSENT}/grant`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          phone_number: phone,
          purpose: 'PAN_TAN_ASSISTANCE',
          granted: true,
          consent_text: consentText
        })
      });
      return await response.json();
                } catch (error) {
      console.error('Failed to grant consent:', error);
      throw error;
    }
  }

  function showConsentBanner() {
    const banner = document.getElementById('consentBanner');
    banner.style.display = 'block';
    document.body.style.paddingTop = '60px';
  }

  function hideConsentBanner() {
    const banner = document.getElementById('consentBanner');
    banner.style.display = 'none';
    document.body.style.paddingTop = '0';
  }

  function showConsentModal(policy) {
    const modal = document.getElementById('consentModal');
    const body = document.getElementById('consentModalBody');
    
    body.innerHTML = `
      <h3>${policy.title}</h3>
      <div style="white-space: pre-line; margin-top: 16px;">${policy.content}</div>
    `;
    
    modal.style.display = 'flex';
    currentConsentPolicy = policy;
  }

  function hideConsentModal() {
    const modal = document.getElementById('consentModal');
    modal.style.display = 'none';
    currentConsentPolicy = null;
  }

  async function handleConsentAccept() {
    if (!phoneNumber || !currentConsentPolicy) return;
    
    try {
      await grantConsent(phoneNumber, currentConsentPolicy.content);
      consentGranted = true;
      hideConsentBanner();
      hideConsentModal();
      
      // Show success message
      addBot('‚úÖ Consent granted! You can now continue with the conversation.');
      enableChat(true);
    } catch (error) {
      showError('Failed to save consent. Please try again.');
    }
  }

  function handleConsentDecline() {
    hideConsentBanner();
    hideConsentModal();
    addBot('‚ùå Consent declined. We cannot process your request without consent. Please refresh to try again.');
    enableChat(false);
  }

  // Frontend no longer manages OTP/history. Backend will handle and reply appropriately.

  async function sendMessage(){
    const text = textInput.value.trim(); if(!text){ return; }
    showError('');
    addUser(text); textInput.value=''; enableChat(false);

    // Capture phone number locally if the user provides it
    const phoneMatch = text.replace(/\s+/g,'').match(/\+?\d{10,20}/);
    if (phoneMatch && !phoneNumber) { 
      phoneNumber = phoneMatch[0]; 
      
      // Check consent when phone number is first provided
      const hasConsent = await checkConsentStatus(phoneNumber);
      if (!hasConsent) {
        const bannerData = await loadConsentBannerData(phoneNumber);
        if (bannerData && bannerData.requires_consent) {
          currentConsentPolicy = bannerData.policy;
          showConsentBanner();
          enableChat(false);
          return;
        }
      } else {
        consentGranted = true;
      }
    }

    // If phone number unknown and message wasn't a number, prompt again
    if (!phoneNumber) {
      addBot('Please enter your phone number to proceed.');
      enableChat(true);
      return;
    }

    // Check if consent is required but not granted
    if (phoneNumber && !consentGranted) {
      addBot('Please provide consent to continue. Click "Accept" in the banner above.');
      enableChat(false);
      return;
    }

    try{
      // Build payload
      const payload = { text, sender_id: senderId };
      if (phoneNumber) { payload.phone_number = phoneNumber; }
      // If the message looks like a phone number, force a new session
      const normalized = text.replace(/\D+/g, '');
      const looksLikePhone = normalized.length >= 10;
      if (looksLikePhone) {
        payload.new_session = true;
        sessionId = null; // allow backend to issue a fresh session id
      }
      if (sessionId) { payload.session_id = sessionId; }

      const res = await fetch(API_CHAT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if(!res.ok){ throw new Error('Chat error'); }
      const data = await res.json();
      if (data && data.session_id) { sessionId = data.session_id; }
      if(Array.isArray(data.replies)){
        let any = false;
        data.replies.forEach(r=>{ if(r && r.text){ addBot(r.text); any = true; } });
        if(!any){ addBot("I didn't understand that. Could you rephrase?"); }
      } else { addBot('No reply received.'); }
    } catch(err){
      console.error(err); showError('Server error. Check servers and try again.');
    } finally { enableChat(true); }
  }
})();
    </script>
</body>
</html>
