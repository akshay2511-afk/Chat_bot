<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAN Card Chatbot</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
  font-family: Arial, sans-serif;
  background-image: url("images/def.png");
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  min-height: 100vh;
}

        /* Floating chat trigger button */
        .chat-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: #ffffff;
            color: #0d6efd;
            border: 0;
            padding: 12px 16px;
            border-radius: 999px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.2);
            cursor: pointer;
            font-weight: 700;
            z-index: 1000;
        }

        /* Chat widget container as a small popup */
        .chat-widget {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 360px;
            height: 520px;
            display: none; /* hidden until opened */
            flex-direction: column;
            background: #ffffff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0,0,0,0.25);
            z-index: 1001;
        }

        .header { background: #5b6be6; color: #fff; padding: 12px 16px; font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
        .header .close-btn { background: transparent; color: #fff; border: 0; font-size: 18px; cursor: pointer; }

        .messages { flex: 1; overflow-y: auto; padding: 16px; background: #fafbff; }
        .row { display: flex; margin-bottom: 10px; }
        .row.user { justify-content: flex-end; }
        .bubble { max-width: 70%; padding: 10px 12px; border-radius: 12px; border: 1px solid #e3e7ff; background: #fff; }
        .row.user .bubble { background: #5b6be6; color: #fff; border-color: transparent; }
        .footer { display: flex; gap: 8px; padding: 12px; border-top: 1px solid #e9ecf8; background: #fff; }
        .input { flex: 1; padding: 10px 12px; border: 1px solid #dfe3f6; border-radius: 8px; }
        .btn { background: #5b6be6; color: #fff; border: 0; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn:disabled { opacity: .6; cursor: not-allowed; }
        .error { color: #e74c3c; text-align: center; font-size: 13px; padding: 6px 0; height: 20px; }
    </style>
</head>
<body>
<button id="chatToggle" class="chat-toggle">üí¨ Chat</button>

<div id="chatWidget" class="chat-widget">
    <div class="header">
        <span>üèõÔ∏è PAN Card Assistant</span>
        <button id="chatClose" class="close-btn" title="Close">‚úï</button>
    </div>

    <div id="error" class="error"></div>

    <div id="messages" class="messages"></div>

    <div class="footer">
        <input id="textInput" class="input" placeholder="Type a message..." disabled>
        <button id="sendBtn" class="btn" disabled>Send</button>
    </div>
</div>

<script>
(function(){
  const widget = document.getElementById('chatWidget');
  const toggle = document.getElementById('chatToggle');
  const closeBtn = document.getElementById('chatClose');
  const messagesEl = document.getElementById('messages');
  const textInput = document.getElementById('textInput');
  const sendBtn = document.getElementById('sendBtn');
  // Phone UI removed
  const errorEl = document.getElementById('error');

  const API_CHAT = '/chat';
  // Backend drives the OTP flow now; UI just relays messages

  let senderId = localStorage.getItem('sender_id') || `user_${Math.random().toString(36).slice(2, 10)}`;
  localStorage.setItem('sender_id', senderId);

  let phoneNumber = '';
  let sessionId = senderId; // reuse sender id as session id
  // Lazy-initialize messages when widget opens for the first time
  let initialized = false;

  function openWidget(){
    widget.style.display = 'flex';
    toggle.style.display = 'none';
    if(!initialized){
      // Ask backend for the greeting + number prompt
      initialized = true;
      enableChat(false);
      fetch(API_CHAT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: '', sender_id: senderId })
      }).then(async res => {
        const data = await res.json().catch(()=>({}));
        if (data && Array.isArray(data.replies)) {
          data.replies.forEach(r=>{ if(r && r.text){ addBot(r.text); } });
        } else {
          addBot("Hello I'm here to assist you for PAN and TAN and i'm comfortable in both the languages Hindi and English.");
          addBot('Can you provide your number for the smooth conversation?');
        }
      }).catch(()=>{
        addBot("Hello I'm here to assist you for PAN and TAN and i'm comfortable in both the languages Hindi and English.");
        addBot('Can you provide your number for the smooth conversation?');
      }).finally(()=>{
        enableChat(true);
      });
    }
  }

  function closeWidget(){
    widget.style.display = 'none';
    toggle.style.display = 'inline-flex';
  }

  sendBtn.addEventListener('click', sendMessage);
  textInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ sendMessage(); }});
  toggle.addEventListener('click', openWidget);
  closeBtn.addEventListener('click', closeWidget);

  function enableChat(enabled){
    textInput.disabled = !enabled; sendBtn.disabled = !enabled;
  }
  function showError(msg){ errorEl.textContent = msg || ''; }

  function addMessage(text, who){
    const row = document.createElement('div'); row.className = `row ${who}`;
    const bubble = document.createElement('div'); bubble.className = 'bubble';
    bubble.textContent = text; row.appendChild(bubble); messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
  function addUser(text){ addMessage(text, 'user'); }
  function addBot(text){ addMessage(text, 'bot'); }

  // Frontend no longer manages OTP/history. Backend will handle and reply appropriately.

  async function sendMessage(){
    const text = textInput.value.trim(); if(!text){ return; }
    showError('');
    addUser(text); textInput.value=''; enableChat(false);

    // Capture phone number locally if the user provides it
    const phoneMatch = text.replace(/\s+/g,'').match(/\+?\d{10,20}/);
    if (phoneMatch && !phoneNumber) { phoneNumber = phoneMatch[0]; }

    // If phone number unknown and message wasn't a number, prompt again
    if (!phoneNumber) {
      addBot('Please enter your phone number to proceed.');
      enableChat(true);
      return;
    }

    try{
      const res = await fetch(API_CHAT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, sender_id: senderId, phone_number: phoneNumber, session_id: sessionId })
      });
      if(!res.ok){ throw new Error('Chat error'); }
      const data = await res.json();
      if(Array.isArray(data.replies)){
        let any = false;
        data.replies.forEach(r=>{ if(r && r.text){ addBot(r.text); any = true; } });
        if(!any){ addBot("I didn't understand that. Could you rephrase?"); }
      } else { addBot('No reply received.'); }
    } catch(err){
      console.error(err); showError('Server error. Check servers and try again.');
    } finally { enableChat(true); }
  }
})();
</script>
</body>
</html>
