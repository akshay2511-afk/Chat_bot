<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAN Card Chatbot</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
  font-family: Arial, sans-serif;
  background-image: url("images/def.png");
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  min-height: 100vh;
}

        /* Floating chat trigger button */
        .chat-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: #ffffff;
            color: #0d6efd;
            border: 0;
            padding: 12px 16px;
            border-radius: 999px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.2);
            cursor: pointer;
            font-weight: 700;
            z-index: 1000;
        }

        /* Chat widget container as a small popup */
        .chat-widget {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 360px;
            height: 520px;
            display: none; /* hidden until opened */
            flex-direction: column;
            background: #ffffff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0,0,0,0.25);
            z-index: 1001;
        }

        .header { background: #5b6be6; color: #fff; padding: 12px 16px; font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
        .header .close-btn { background: transparent; color: #fff; border: 0; font-size: 18px; cursor: pointer; }

        .messages { flex: 1; overflow-y: auto; padding: 16px; background: #fafbff; }
        .row { display: flex; margin-bottom: 10px; }
        .row.user { justify-content: flex-end; }
        .bubble { max-width: 70%; padding: 10px 12px; border-radius: 12px; border: 1px solid #e3e7ff; background: #fff; }
        .row.user .bubble { background: #5b6be6; color: #fff; border-color: transparent; }
        .footer { display: flex; gap: 8px; padding: 12px; border-top: 1px solid #e9ecf8; background: #fff; }
        .input { flex: 1; padding: 10px 12px; border: 1px solid #dfe3f6; border-radius: 8px; }
        .btn { background: #5b6be6; color: #fff; border: 0; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn:disabled { opacity: .6; cursor: not-allowed; }
        .error { color: #e74c3c; text-align: center; font-size: 13px; padding: 6px 0; height: 20px; }
    </style>
</head>
<body>
<button id="chatToggle" class="chat-toggle">üí¨ Chat</button>

<div id="chatWidget" class="chat-widget">
    <div class="header">
        <span>üèõÔ∏è PAN Card Assistant</span>
        <button id="chatClose" class="close-btn" title="Close">‚úï</button>
    </div>

    <div id="error" class="error"></div>

    <div id="messages" class="messages"></div>

    <div class="footer">
        <input id="textInput" class="input" placeholder="Type a message..." disabled>
        <button id="sendBtn" class="btn" disabled>Send</button>
    </div>
</div>

<script>
(function(){
  const widget = document.getElementById('chatWidget');
  const toggle = document.getElementById('chatToggle');
  const closeBtn = document.getElementById('chatClose');
  const messagesEl = document.getElementById('messages');
  const textInput = document.getElementById('textInput');
  const sendBtn = document.getElementById('sendBtn');
  // Phone UI removed
  const errorEl = document.getElementById('error');

  const API_CHAT = '/chat';
  const API_HISTORY = (pn) => `/api/conversations/${encodeURIComponent(pn)}`;
  const API_ENSURE = (pn) => `/api/conversations/ensure/${encodeURIComponent(pn)}`;
  const API_GENERATE_OTP = '/api/otp/generate';
  const API_VERIFY_OTP = '/api/otp/verify';
  const API_CHECK_VERIFIED = (pn) => `/api/otp/verified/${encodeURIComponent(pn)}`;

  let senderId = localStorage.getItem('sender_id') || `user_${Math.random().toString(36).slice(2, 10)}`;
  localStorage.setItem('sender_id', senderId);

  let phoneNumber = '';
  let isPhoneVerified = false;
  let waitingForOTP = false;
  // Lazy-initialize messages when widget opens for the first time
  let initialized = false;

  function openWidget(){
    widget.style.display = 'flex';
    toggle.style.display = 'none';
    if(!initialized){
      addBot("üëã Hello! I'm here for your query. Please enter your phone number first.");
      enableChat(true);
      initialized = true;
    }
  }

  function closeWidget(){
    widget.style.display = 'none';
    toggle.style.display = 'inline-flex';
  }

  sendBtn.addEventListener('click', sendMessage);
  textInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ sendMessage(); }});
  toggle.addEventListener('click', openWidget);
  closeBtn.addEventListener('click', closeWidget);

  function enableChat(enabled){
    textInput.disabled = !enabled; sendBtn.disabled = !enabled;
  }
  function showError(msg){ errorEl.textContent = msg || ''; }

  function addMessage(text, who){
    const row = document.createElement('div'); row.className = `row ${who}`;
    const bubble = document.createElement('div'); bubble.className = 'bubble';
    bubble.textContent = text; row.appendChild(bubble); messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
  function addUser(text){ addMessage(text, 'user'); }
  function addBot(text){ addMessage(text, 'bot'); }

  async function checkPhoneVerification(phoneNumber) {
    try {
      const res = await fetch(API_CHECK_VERIFIED(phoneNumber));
      if (res.ok) {
        const data = await res.json();
        console.log(`DEBUG: Phone verification check for ${phoneNumber}:`, data);
        return data.verified;
      }
    } catch (err) {
      console.error('Error checking phone verification:', err);
    }
    return false;
  }

  async function generateOTP(phoneNumber) {
    try {
      const res = await fetch(API_GENERATE_OTP, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone_number: phoneNumber })
      });
      
      if (res.ok) {
        const data = await res.json();
        return { success: true, message: data.message };
      } else {
        const error = await res.json();
        return { success: false, message: error.detail || 'Failed to generate OTP' };
      }
    } catch (err) {
      return { success: false, message: 'Network error while generating OTP' };
    }
  }

  async function verifyOTP(phoneNumber, otpCode) {
    try {
      const res = await fetch(API_VERIFY_OTP, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone_number: phoneNumber, otp_code: otpCode })
      });
      
      if (res.ok) {
        const data = await res.json();
        console.log(`DEBUG: OTP verification response for ${phoneNumber}:`, data);
        return { success: true, message: data.message };
      } else {
        const error = await res.json();
        console.log(`DEBUG: OTP verification error for ${phoneNumber}:`, error);
        return { success: false, message: error.detail || 'Failed to verify OTP' };
      }
    } catch (err) {
      console.error('Network error while verifying OTP:', err);
      return { success: false, message: 'Network error while verifying OTP' };
    }
  }

  async function preloadHistory(pn){
    try{
      const res = await fetch(API_HISTORY(pn));
      if(!res.ok){ throw new Error('Failed to load history'); }
      const data = await res.json();
      messagesEl.innerHTML = '';
      // New format: { phone_number, conversation: { message: "user: hi\nbot: hello", ... } }
      if (data && data.conversation && data.conversation.message){
        const text = String(data.conversation.message);
        const lines = text.split(/\n+/);
        lines.forEach(line => {
          const m = /^(user|bot)\s*:\s*(.*)$/i.exec(line.trim());
          if (m){
            const who = m[1].toLowerCase() === 'user' ? 'user' : 'bot';
            const content = m[2];
            addMessage(content, who);
          } else if(line.trim()) {
            addBot(line.trim());
          }
        });
      }
      // Backward compatibility with old list format
      else if (data && data.conversations && data.conversations.length){
        data.conversations.forEach(m => addMessage(m.message, m.role === 'user' ? 'user' : 'bot'));
      } else {
        addBot("History empty. Please type 'hi' to begin.");
      }
    } catch(err){
      addBot('Could not load history. You can still start chatting.');
      console.error(err);
    }
  }

  async function sendMessage(){
    const text = textInput.value.trim(); if(!text){ return; }
    showError('');
    addUser(text); textInput.value=''; enableChat(false);

    // If user sends a phone number at any time, (re)trigger OTP flow every time
    const phoneMatch = text.replace(/\s+/g,'').match(/\+?\d{10,20}/);
    if (phoneMatch) {
      phoneNumber = phoneMatch[0];
      try { await fetch(API_ENSURE(phoneNumber), { method: 'POST' }); } catch(_e) {}
      isPhoneVerified = false;
      waitingForOTP = false;
      addBot('üì± Phone number received. Please verify with OTP to access your chat history.');
      addBot('üîê Generating OTP for verification...');
      const otpResult = await generateOTP(phoneNumber);
      if (otpResult.success) {
        addBot(otpResult.message);
        addBot('Please enter the 6-digit OTP code:');
        waitingForOTP = true;
      } else {
        addBot('‚ùå ' + otpResult.message);
      }
      enableChat(true);
      return;
    }

    // If phone number not known yet (and message wasn't a phone), stop and ask
    if(!phoneNumber){
      const m = text.replace(/\s+/g,'').match(/\+?\d{10,20}/);
      if(m){
        phoneNumber = m[0];
        try { await fetch(API_ENSURE(phoneNumber), { method: 'POST' }); } catch(_e) {}
        // Always require OTP before any chat or history load
        isPhoneVerified = false;
        addBot('üì± Phone number received. Please verify with OTP to access your chat history.');
        addBot('üîê Generating OTP for verification...');
        const otpResult = await generateOTP(phoneNumber);
        if (otpResult.success) {
          addBot(otpResult.message);
          addBot('Please enter the 6-digit OTP code:');
          waitingForOTP = true;
        } else {
          addBot('‚ùå ' + otpResult.message);
          enableChat(true);
          return;
        }
      } else {
        addBot('Please enter a valid phone number to proceed.');
        enableChat(true);
        return;
      }
    }
    // Handle OTP verification
    else if (waitingForOTP) {
      const otpMatch = text.match(/^\d{6}$/);
      if (otpMatch) {
        addBot('üîç Verifying OTP...');
        const verifyResult = await verifyOTP(phoneNumber, text);
        
        if (verifyResult.success) {
          addBot('‚úÖ ' + verifyResult.message);
          isPhoneVerified = true;
          waitingForOTP = false;
          
          // Double-check verification status from backend with a small delay
          await new Promise(resolve => setTimeout(resolve, 500)); // 500ms delay
          const backendVerified = await checkPhoneVerification(phoneNumber);
          if (backendVerified) {
            addBot('Loading your previous conversations...');
            await preloadHistory(phoneNumber);
          } else {
            addBot('‚ö†Ô∏è Verification completed but backend status unclear. Please try again.');
          }
        } else {
          addBot('‚ùå ' + verifyResult.message);
          addBot('Please enter the correct 6-digit OTP:');
        }
      } else {
        addBot('Please enter a valid 6-digit OTP code.');
      }
      enableChat(true);
      return;
    }

    // Only proceed with chat if phone is verified
    if (!isPhoneVerified) {
      addBot('Please verify your phone number with OTP first to start chatting.');
      enableChat(true);
      return;
    }

    try{
      const res = await fetch(API_CHAT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, sender_id: senderId, phone_number: phoneNumber })
      });
      if(!res.ok){ throw new Error('Chat error'); }
      const data = await res.json();
      if(Array.isArray(data.replies)){
        let any = false;
        data.replies.forEach(r=>{ if(r && r.text){ addBot(r.text); any = true; } });
        if(!any){ addBot("I didn't understand that. Could you rephrase?"); }
      } else { addBot('No reply received.'); }
    } catch(err){
      console.error(err); showError('Server error. Check servers and try again.');
    } finally { enableChat(true); }
  }
})();
</script>
</body>
</html>
